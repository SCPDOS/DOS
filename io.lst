     1                                      DEFAULT REL
     2                                      [map all io.map]
     3                                  
     4                                  STRUC   bpb         ;FAT 12 and 16 BPB
     5                                  
     6 00000000 ??????                      .jmpBoot    resb 3
     7 00000003 ????????????????            .oemName    resb 8  ;OEM name
     8 0000000B ????                        .bytsPerSec resw 1  ;Bytes per sector
     9 0000000D ??                          .secPerClus resb 1  ;Sectors per cluster
    10 0000000E ????                        .revdSecCnt resw 1  ;Number of reserved sectors
    11 00000010 ??                          .numFATs    resb 1  ;Number of FATs on media
    12 00000011 ????                        .rootEntCnt resw 1  ;Number of entries in Root directory
    13 00000013 ????                        .totSec16   resw 1  ;Number of sectors on medium
    14 00000015 ??                          .media      resb 1  ;Media descriptor byte
    15 00000016 ????                        .FATsz16    resw 1  ;Number of sectors per FAT
    16 00000018 ????                        .secPerTrk  resw 1  ;Number of sectors per "track"
    17 0000001A ????                        .numHeads   resw 1  ;Number of read "heads"
    18 0000001C ????????                    .hiddSec    resd 1  ;Number of hidden sectors
    19 00000020 ????????                    .totSec32   resd 1  ;32 bit count of sectors
    20                                  
    21 00000024 ??                          .drvNum     resb 1  ;Logical drive number (00h or 80h)
    22 00000025 ??                          .reserved1  resb 1  ;Reserved byte
    23 00000026 ??                          .bootSig    resb 1  ;Extended boot signature (29h)
    24 00000027 ????????                    .volID      resd 1  ;Volume serial number
    25 0000002B <res Bh>                    .volLab     resb 11 ;Volume label string
    26 00000036 ????????????????            .filSysType resb 8  ;File system type string
    27                                  
    28                                  ENDSTRUC
    29                                  
    30                                  STRUC   bpb32       ;FAT 32 BPB
    31                                  
    32 00000000 ??????                      .jmpBoot    resb 3
    33 00000003 ????????????????            .oemName    resb 8  ;OEM name
    34 0000000B ????                        .bytsPerSec resw 1  ;Bytes per sector
    35 0000000D ??                          .secPerClus resb 1  ;Sectors per cluster
    36 0000000E ????                        .revdSecCnt resw 1  ;Number of reserved sectors
    37 00000010 ??                          .numFATs    resb 1  ;Number of FATs on media
    38 00000011 ????                        .rootEntCnt resw 1  ;Number of entries in Root directory
    39 00000013 ????                        .totSec16   resw 1  ;Number of sectors on medium
    40 00000015 ??                          .media      resb 1  ;Media descriptor byte
    41 00000016 ????                        .FATsz16    resw 1  ;Number of sectors per FAT, must be 0 for FAT 32
    42 00000018 ????                        .secPerTrk  resw 1  ;Number of sectors per "track"
    43 0000001A ????                        .numHeads   resw 1  ;Number of read "heads"
    44 0000001C ????????                    .hiddSec    resd 1  ;Number of hidden sectors
    45 00000020 ????????                    .totSec32   resd 1  ;32 bit count of sectors
    46                                  
    47 00000024 ????????                    .FATsz32    resd 1  ;32 bit count of sectors occupied by one FAT
    48 00000028 ????                        .extFlags   resw 1  ;Extended Flags word
    49 0000002A ????                        .FSver      resw 1  ;File system version word, must be 0
    50 0000002C ????????                    .RootClus   resd 1  ;First Cluster of Root Directory
    51 00000030 ????                        .FSinfo     resw 1  ;Sector number of FSINFO structure, usually 1
    52 00000032 ????                        .BkBootSec  resw 1  ;Backup Boot sector, either 0 or 6
    53 00000034 <res Ch>                    .reserved   resb 12 ;Reserved 12 bytes
    54                                  
    55 00000040 ??                          .drvNum     resb 1  ;Logical drive number (00h or 80h)
    56 00000041 ??                          .reserved1  resb 1  ;Reserved byte
    57 00000042 ??                          .bootSig    resb 1  ;Extended boot signature (29h)
    58 00000043 ????????                    .volID      resd 1  ;Volume serial number
    59 00000047 <res Bh>                    .volLab     resb 11 ;Volume label string
    60 00000052 ????????????????            .filSysType resb 8  ;File system type string
    61                                  
    62                                  ENDSTRUC
    63                                  
    64                                  STRUC   bpbEx       ;exFAT BPB
    65                                  
    66 00000000 ??????                      .jmpBoot                resb 3 
    67 00000003 ????????????????            .oemName                resb 8  ;OEM name
    68 0000000B <res 35h>                   .MustBeZero             resb 53 ;Must be 0, 53 bytes
    69 00000040 ????????????????            .partitionOffset        resq 1  ;in sectors, 0 means ignore this field
    70 00000048 ????????????????            .volumeLength           resq 1  ;Volume Length in sectors
    71 00000050 ????????                    .FAToffset              resd 1  ;Volume rel offset of first FAT, in sectors
    72 00000054 ????????                    .FATlength              resd 1  ;FAT length, in sectors
    73 00000058 ????????                    .clusterHeapOffset      resd 1  ;Start of data area, in sectors
    74 0000005C ????????                    .clusterCount           resd 1  ;Number of clusters on medium
    75 00000060 ????????                    .firstClusterOfRootDir  resd 1  ;First Cluster of Root Directory, min 2
    76 00000064 ????????                    .volumeSerialNum        resd 1  ;Volume Serial Number
    77 00000068 ????                        .FSrevision             resw 1  ;Should be 0001 (v1.00)
    78 0000006A ????                        .volumeFlags            resw 1  ;Volume Flags, refer to documentation
    79 0000006C ??                          .bytesPerSectorShift    resb 1  ;min 9 (512 bps), max 12 (4096 bps)
    80 0000006D ??                          .sectorsPerClusterShift resb 1  ;Result of log_2(N) for N=sec per clus
    81 0000006E ??                          .numberOfFATs           resb 1  ;Number of FATs, only 1 or 2
    82 0000006F ??                          .driveSelect            resb 1  ;Drive Select, 0 or 80h (Int 13h)
    83 00000070 ??                          .percentInUse           resb 1  ;Rounded down. FFh means unknown
    84 00000071 ??????????????              .reserved               resb 7  ;Reserved for alignment
    85                                  
    86                                  ENDSTRUC
    87                                  
    88                                  STRUC   dpb         ;Drive Parameter Block
    89                                  
    90 00000000 ??                          .bDriveNumber               resb 1  ;Drive number
    91 00000001 ??                          .bUnitNumber                resb 1  ;Unit number in device
    92 00000002 ??                          .bBytesPerSectorShift       resb 1  ;min 9 (512 bps), max 12 (4096 bps)
    93 00000003 ??                          .bMaxSectorInCluster        resb 1  ;(Maximum sector in cluster) - 1
    94                                  ;                                        i.e. (2^bSectorsPerClusterShift) - 1
    95 00000004 ??                          .bSectorsPerClusterShift    resb 1  ;Sectors per cluster exponent
    96 00000005 ????????                    .dFAToffset                 resd 1  ;Vol rel offset of first FAT, in sectors
    97 00000009 ??                          .bNumberOfFATs              resb 1  ;Number of FATs
    98 0000000A ????                        .wNumberRootDirEntries      resw 1  ;In sectors
    99 0000000C ????????                    .dClusterHeapOffset         resd 1  ;Start of data area, in sectors
   100 00000010 ????????                    .dClusterCount              resd 1  ;Total number of clusters (volume size)
   101 00000014 ????????                    .dFATlength                 resd 1  ;FAT length, in sectors
   102 00000018 ????????                    .dFirstClusterOfRootDir     resd 1  ;First Cluster of Root Directory, min 2
   103 0000001C ????????????????            .qDriverHeaderPtr           resq 1  ;Pointer to device driver header
   104 00000024 ??                          .bMediaDescriptor           resb 1  ;Media descriptor
   105 00000025 ??                          .bAccessFlag                resb 1  ;Access Flag (0 if accessed, else -1)
   106 00000026 ????????????????            .qNextDPBPtr                resq 1  ;Pointer to next DPB, -1 if at end
   107 0000002E ????????                    .dFirstFreeCluster          resd 1  ;Starting cluster of free space search
   108 00000032 ????????                    .dNumberOfFreeClusters      resd 1  ;Number of free clusters, -1 unknown
   109                                  
   110                                  ENDSTRUC
   111                                  
   112                                  STRUC   drvHdr      ;Device Driver Header for character and block devices
   113                                  
   114 00000000 ????????????????            .qPtrnxt resq 1  ;Pointer to the next driver header, -1 if at the end
   115 00000008 ????                        .wAttrib resw 1  ;Attribute Word
   116 0000000A ????????????????            .qStratp resq 1  ;Strategy Entry Pointer
   117 00000012 ????????????????            .qInterp resq 1  ;Interrupt Entry Pointer
   118                                      .bUntnum:        ;Unit number byte (Block Only)
   119 0000001A ????????????????            .vDrvnam resb 8  ;Driver name (Character Only)
   120                                  
   121                                  ENDSTRUC
   122                                  
   123                                  STRUC   drvReqHdr   ;Driver Request Header
   124                                  
   125 00000000 ??                          .length resb 1  ;Length of the request header
   126 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   127 00000002 ??                          .cmdcde resb 1  ;Command code
   128 00000003 ????                        .status resw 1  ;Status word
   129 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   130 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   131                                  
   132                                  ENDSTRUC
   133                                  
   134                                  STRUC   initReqPkt   ;Init Request Packet
   135                                  
   136 00000000 ??                          .length resb 1  ;Length of the request header
   137 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   138 00000002 ??                          .cmdcde resb 1  ;Command code
   139 00000003 ????                        .status resw 1  ;Status word
   140 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   141 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   142                                  
   143 00000015 ??                          .numunt resb 1  ;Number of logical units (Block only, 0 for char)
   144 00000016 ????????????????            .endptr resq 1  ;Pointer to first free byte after driver
   145 0000001E ????????????????            .optptr resq 1  ;Pointer to the BPB array (block) or optional args (char)
   146 00000026 ??                          .drvnum resb 1  ;Drive number
   147                                  
   148                                  ENDSTRUC
   149                                  
   150                                  STRUC mediaCheckReqPkt  ;Media Check Request Packet
   151                                  
   152 00000000 ??                          .length resb 1  ;Length of the request header
   153 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   154 00000002 ??                          .cmdcde resb 1  ;Command code
   155 00000003 ????                        .status resw 1  ;Status word
   156 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   157 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   158                                  
   159 00000015 ??                          .medesc resb 1  ;DOS media descriptor
   160 00000016 ??                          .medret resb 1  ;Return byte (Has media been changed?)
   161 00000017 ????????????????            .desptr resq 1  ;Pointer to a valid volume id field
   162                                  
   163                                  ENDSTRUC
   164                                  
   165                                  STRUC bpbBuildReqPkt   ;Build BPB Request Packet
   166                                  
   167 00000000 ??                          .length resb 1  ;Length of the request header
   168 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   169 00000002 ??                          .cmdcde resb 1  ;Command code
   170 00000003 ????                        .status resw 1  ;Status word
   171 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   172 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   173                                  
   174 00000015 ??                          .medesc resb 1  ;DOS media descriptor
   175 00000016 ????????????????            .bufptr resq 1  ;Transfer buffer
   176 0000001E ????????????????            .bpbptr resq 1  ;Pointer to the BPB
   177                                  
   178                                  ENDSTRUC
   179                                  
   180                                  
   181                                  STRUC ioReqPkt      ;IO Request Packet
   182                                  
   183 00000000 ??                          .length resb 1  ;Length of the request header
   184 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   185 00000002 ??                          .cmdcde resb 1  ;Command code
   186 00000003 ????                        .status resw 1  ;Status word
   187 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   188 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   189                                  
   190 00000015 ??                          .medesc resb 1  ;DOS media descriptor
   191 00000016 ????????????????            .bufptr resq 1  ;Transfer buffer
   192 0000001E ????                        .tfrlen resw 1  ;Number of Sectors/bytes to transfer
   193 00000020 ????????????????            .strtsc resq 1  ;Starting sector for transfer
   194 00000028 ????????????????            .desptr resq 1  ;Pointer to a valid volume id field if error
   195                                  
   196                                  ENDSTRUC
   197                                  
   198                                  STRUC nonDestInNoWaitReqPkt   ;Nondestructive Input No Wait Request Packet
   199                                      
   200 00000000 ??                          .length resb 1  ;Length of the request header
   201 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   202 00000002 ??                          .cmdcde resb 1  ;Command code
   203 00000003 ????                        .status resw 1  ;Status word
   204 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   205 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   206                                  
   207 00000015 ??                          .retbyt resb 1  ;Byte read non destructively
   208                                  
   209                                  ENDSTRUC
   210                                  
   211                                  STRUC statusReqPkt  ;Status Request Packet
   212                                      
   213 00000000 ??                          .length resb 1  ;Length of the request header
   214 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   215 00000002 ??                          .cmdcde resb 1  ;Command code
   216 00000003 ????                        .status resw 1  ;Status word
   217 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   218 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   219                                  
   220                                  ENDSTRUC
   221                                  
   222                                  STRUC flushReqPkt   ;Flush Request Packet, terminate all pending requests
   223                                      
   224 00000000 ??                          .length resb 1  ;Length of the request header
   225 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   226 00000002 ??                          .cmdcde resb 1  ;Command code
   227 00000003 ????                        .status resw 1  ;Status word
   228 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   229 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   230                                  
   231                                  ENDSTRUC
   232                                  
   233                                  STRUC openReqPkt    ;Open Device Request Packet
   234                                      
   235 00000000 ??                          .length resb 1  ;Length of the request header
   236 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   237 00000002 ??                          .cmdcde resb 1  ;Command code
   238 00000003 ????                        .status resw 1  ;Status word
   239 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   240 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   241                                  
   242                                  ENDSTRUC
   243                                  
   244                                  STRUC closeReqPkt   ;Close Device Request Packet
   245                                      
   246 00000000 ??                          .length resb 1  ;Length of the request header
   247 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   248 00000002 ??                          .cmdcde resb 1  ;Command code
   249 00000003 ????                        .status resw 1  ;Status word
   250 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   251 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   252                                  
   253                                  ENDSTRUC
   254                                  
   255                                  STRUC remMediaReqPkt    ;Removeable Media? Request Packet
   256                                      
   257 00000000 ??                          .length resb 1  ;Length of the request header
   258 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   259 00000002 ??                          .cmdcde resb 1  ;Command code
   260 00000003 ????                        .status resw 1  ;Status word
   261 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   262 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   263                                  
   264                                  ENDSTRUC
   265                                  
   266                                  STRUC ioctlReqPkt   ;Generic IOCTL Request Packet
   267                                      
   268 00000000 ??                          .length resb 1  ;Length of the request header
   269 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   270 00000002 ??                          .cmdcde resb 1  ;Command code
   271 00000003 ????                        .status resw 1  ;Status word
   272 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   273 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   274                                  
   275 00000015 ??                          .majfun resb 1  ;Major function number
   276 00000016 ??                          .minfun resb 1  ;Minor function number
   277 00000017 ????????????????            .rsival resq 1  ;Contents of RSI
   278 0000001F ????????????????            .rdival resq 1  ;Contents of RDI
   279 00000027 ????????????????            .ctlptr resq 1  ;Pointer to Generic IOCTL Request Packet
   280                                  
   281                                  ENDSTRUC
   282                                  
   283                                  STRUC getDevReqPkt  ;Get Logical Device Request Packet
   284                                      
   285 00000000 ??                          .length resb 1  ;Length of the request header
   286 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   287 00000002 ??                          .cmdcde resb 1  ;Command code
   288 00000003 ????                        .status resw 1  ;Status word
   289 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   290 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   291                                  
   292 00000015 ??                          .getcmd resb 1  ;Command code
   293 00000016 ????                        .cmdsts resw 1  ;Command status word
   294                                  
   295                                  ENDSTRUC
   296                                  
   297                                  STRUC setDevReqPkt  ;Set Logical Device Request Packet
   298                                      
   299 00000000 ??                          .length resb 1  ;Length of the request header
   300 00000001 ??                          .unitnm resb 1  ;Unit number, meaningless for character devs
   301 00000002 ??                          .cmdcde resb 1  ;Command code
   302 00000003 ????                        .status resw 1  ;Status word
   303 00000005 ????????????????            .dosptr resq 1  ;DOS queue pointer field
   304 0000000D ????????????????            .devptr resq 1  ;Device queue pointer field
   305                                  
   306 00000015 ??                          .setcmd resb 1  ;Command code
   307 00000016 ????                        .cmdsts resw 1  ;Command status word
   308                                  
   309                                  ENDSTRUC
   310                                  
   311                                      BITS 64
   312                                  Section loader vstart=7C00h align=1
   313 00000000 55AA                        dw 0AA55h           ;Initial signature
   314 00000002 48BD-                       mov rbp, startmsg
   314 00000004 [0000000000000000] 
   315 0000000C B804130000                  mov eax, 1304h
   316 00000011 CD30                        int 30h
   317                                  
   318 00000013 EBFE                        jmp short $
   319                                  
   320                                  Section loaderData vfollows=loader align=4
   321 00000000 0A0D5374617274696E-     startmsg db 0Ah,0Dh,"Starting SCP/DOS...",0Ah,0Dh,0
   321 00000009 67205343502F444F53-
   321 00000012 2E2E2E0A0D00       
