     1                                      DEFAULT REL
     2                                      [map all io.map]
     3                                      BITS 64
     4                                  Section loader vstart=7C00h align=1
     5 00000000 55AA                        dw 0AA55h           ;Initial signature
     6                                  
     7 00000002 B800060000                  mov eax, 0600h  ;CLS
     8 00000007 31C9                        xor ecx, ecx
     9 00000009 BA4F180000                  mov edx, 184Fh
    10 0000000E B707                        mov bh, 07h
    11 00000010 CD30                        int 30h
    12 00000012 B800020000                  mov eax, 0200h  ;Move cursor up top
    13 00000017 31D2                        xor edx, edx
    14 00000019 30FF                        xor bh, bh
    15 0000001B CD30                        int 30h
    16 0000001D 48BD-                       mov rbp, startmsg
    16 0000001F [1801000000000000] 
    17 00000027 B804130000                  mov eax, 1304h
    18 0000002C CD30                        int 30h
    19 0000002E B9000100C0                  mov ecx, 0C0000100h
    20 00000033 0F32                        rdmsr
    21 00000035 4889C5                      mov rbp, rax    ;Save ptr in rbp
    22 00000038 6687DB                      xchg bx, bx
    23                                  lp:
    24 0000003B 30D2                        xor dl, dl
    25 0000003D B482                        mov ah, 82h
    26 0000003F B034                        mov al, 52  ;Read 52 sectors
    27 00000041 B921000000                  mov ecx, 33 ;Start at sector 33
    28 00000046 48BB00002000000000-         mov rbx, 200000h    ;Start at 2Mb range
    28 0000004F 00                 
    29 00000050 CD33                        int 33h
    30 00000052 0F82BB000000                jc exit
    31                                  
    32 00000058 30D2                        xor dl, dl
    33 0000005A B483                        mov ah, 83h
    34 0000005C B034                        mov al, 52  ;Write 52 sectors
    35 0000005E B900010000                  mov ecx, 100h ;Start at sector 256
    36 00000063 48BB00002000000000-         mov rbx, 200000h    ;Start at 2Mb range
    36 0000006C 00                 
    37 0000006D CD33                        int 33h
    38 0000006F 0F829E000000                jc exit
    39                                  
    40 00000075 B9000D0000                  mov ecx, 0D00h ;Number of qwords in 52 sectors
    41 0000007A 31C0                        xor eax, eax
    42 0000007C 48BF00002000000000-         mov rdi, 200000h
    42 00000085 00                 
    43 00000086 F348AB                      rep stosq   ;Clear buffer
    44                                  
    45 00000089 30D2                        xor dl, dl
    46 0000008B B482                        mov ah, 82h
    47 0000008D B034                        mov al, 52  ;Read 52 sectors
    48 0000008F B921000000                  mov ecx, 33 ;Start at sector 33
    49 00000094 48BB00002000000000-         mov rbx, 200000h    ;Start at 2Mb range
    49 0000009D 00                 
    50 0000009E CD33                        int 33h
    51 000000A0 7271                        jc exit
    52                                  
    53 000000A2 30D2                        xor dl, dl
    54 000000A4 B482                        mov ah, 82h
    55 000000A6 B034                        mov al, 52  ;Read 52 sectors
    56 000000A8 B900010000                  mov ecx, 100h ;Start at sector 256
    57 000000AD 48BB00003000000000-         mov rbx, 300000h    ;Start at 3Mb range
    57 000000B6 00                 
    58 000000B7 CD33                        int 33h
    59 000000B9 7258                        jc exit
    60                                  
    61 000000BB B9000D0000                  mov ecx, 0D00h ;Number of qwords in 52 sectors
    62 000000C0 48BF00002000000000-         mov rdi, 200000h
    62 000000C9 00                 
    63 000000CA 48BE00003000000000-         mov rsi, 300000h
    63 000000D3 00                 
    64 000000D4 F348A7                      repe cmpsq   ;Clear buffer
    65 000000D7 85C9                        test ecx, ecx
    66 000000D9 7527                        jnz exit1
    67                                  lp0:
    68 000000DB 48BD-                       mov rbp, strngok
    68 000000DD [5001000000000000] 
    69 000000E5 B804130000                  mov eax, 1304h
    70 000000EA CD30                        int 30h
    71                                  lp1:
    72 000000EC 48BD-                       mov rbp, strng
    72 000000EE [2E01000000000000] 
    73 000000F6 B804130000                  mov eax, 1304h
    74 000000FB CD30                        int 30h
    75 000000FD E9FBFFFFFF                  jmp $
    76                                  exit1:
    77 00000102 48BD-                       mov rbp, strngok
    77 00000104 [5001000000000000] 
    78 0000010C B804130000                  mov eax, 1304h
    79 00000111 CD30                        int 30h
    80                                  exit:
    81 00000113 6687DB                      xchg bx, bx
    82 00000116 EBD4                        jmp short lp1
    83 00000118 5374617274696E6720-     startmsg db "Starting SCP/DOS...",0Ah,0Dh,0
    83 00000121 5343502F444F532E2E-
    83 0000012A 2E0A0D00           
    84 0000012E 0A0D496E76616C6964-     strng db 0Ah, 0Dh,"Invalid IO.SYS. System Halting.",0
    84 00000137 20494F2E5359532E20-
    84 00000140 53797374656D204861-
    84 00000149 6C74696E672E00     
    85 00000150 0A0D53756363657373-     strngok db 0Ah, 0Dh, "Success!",0
    85 00000159 2100               
    86 0000015B 0A0D4661696C2100        strngnok db 0Ah, 0Dh, "Fail!",0
